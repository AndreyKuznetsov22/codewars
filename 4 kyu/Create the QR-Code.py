#https://www.codewars.com/kata/5fa50a5def5ecf0014debd73

from preloaded import htmlize, alphaTable

byte = "{:08b}".format
fill = "1110110000010001"*9
gen = [0, 43, 139, 206, 78, 43, 239, 123, 206, 214, 147, 24, 99, 150, 39, 243, 163, 136]
alphaReverse = {x:i for i,x in enumerate(alphaTable)}

def create_qr_code(text):
    code = "0100"
    code += byte(len(text))
    code += ''.join(map(byte, map(ord, text)))
    code += "0000"
    code += fill[:72-len(code)]
    
    msg = [int(code[i:i+8], 2) for i in range(0, 72, 8)]
    for _ in range(9):
        if msg[0]:
            x = alphaTable[msg[0]]
            tmp = [alphaReverse[(x+y)%255] for y in gen]
            tmp = [y ^ (msg[i] if i<len(msg) else 0) for i,y in enumerate(tmp)]
            msg = tmp[1:]
        else:
            msg = msg[1:]
    if len(msg) < 17:
        msg = [0]*(17-len(msg)) + msg
    code += ''.join(map(byte, msg))
    
    result = [
        [1,1,1,1,1,1,1,0,1,2,2,2,2,0,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,1,0,0,2,2,2,2,0,1,0,0,0,0,0,1],
        [1,0,1,1,1,0,1,0,0,2,2,2,2,0,1,0,1,1,1,0,1],
        [1,0,1,1,1,0,1,0,1,2,2,2,2,0,1,0,1,1,1,0,1],
        [1,0,1,1,1,0,1,0,0,2,2,2,2,0,1,0,1,1,1,0,1],
        [1,0,0,0,0,0,1,0,0,2,2,2,2,0,1,0,0,0,0,0,1],
        [1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1],
        [0,0,0,0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0],
        [0,0,1,0,1,1,1,0,1,2,2,2,2,1,0,0,0,1,0,0,1],
        [2,2,2,2,2,2,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
        [2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
        [2,2,2,2,2,2,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
        [2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
        [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2],
        [1,1,1,1,1,1,1,0,0,2,2,2,2,2,2,2,2,2,2,2,2],
        [1,0,0,0,0,0,1,0,1,2,2,2,2,2,2,2,2,2,2,2,2],
        [1,0,1,1,1,0,1,0,1,2,2,2,2,2,2,2,2,2,2,2,2],
        [1,0,1,1,1,0,1,0,0,2,2,2,2,2,2,2,2,2,2,2,2],
        [1,0,1,1,1,0,1,0,1,2,2,2,2,2,2,2,2,2,2,2,2],
        [1,0,0,0,0,0,1,0,0,2,2,2,2,2,2,2,2,2,2,2,2],
        [1,1,1,1,1,1,1,0,0,2,2,2,2,2,2,2,2,2,2,2,2]]
    
    it, down = map(int, code), list(range(21))
    up = down[::-1]
    for x in range(20, 0, -2):
        if x <= 6:
            x -= 1
        for y in (up if x%4 in (0, 3) else down):
            if result[y][x] == 2:
                if (x+y)%2 == 0:
                    result[y][x] = 1 - next(it)
                    result[y][x-1] = next(it)
                else:
                    result[y][x] = next(it)
                    result[y][x-1] = 1 - next(it)
    return result